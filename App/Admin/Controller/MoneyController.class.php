<?php/** * Author: huanglele * Date: 2016/1/28 * Time: 20:43 * Description: */namespace Admin\Controller;use Admin\Controller;class MoneyController extends CommonController{    public function _initialize(){        parent::_initialize();        $this->checkRole(array(1,3));    }    /**     * 微信账单     */    public function index(){        $map = array();        $uid = I('get.uid');        $this->assign('uid',$uid);        if($uid){            $map['uid'] = $uid;        }        $mytrade = I('get.mytrade');        $this->assign('mytrade',$mytrade);        if($mytrade){            $map['mytrade'] = $mytrade;        }        $wxtrade = I('get.wxtrade');        $this->assign('wxtrade',$wxtrade);        if($wxtrade){            $map['wxtrade'] = $wxtrade;        }        $status = I('get.status',0,'number_int');        $this->assign('status',$status);        if($status>=0){            $map['status'] = $status;        }        $this->getData(M('wxpay'),$map,'mytrade desc');        $this->assign('PayStatus',C('wxPayStatus'));        $this->display('wxpay');    }    public function user(){        $this->assign('MoneyType',C('MoneyType'));        $map = array();        $uid = I('get.uid','','number_int');        $this->assign('uid',$uid);        if($uid){            $map['uid'] = $uid;        }        $type = I('get.type',0);        if($type)$map['type'] = $type;        $this->assign('type',$type);        $M = M('money');        $order = 'mid desc';        $this->getData($M,$map,$order);        $this->display('user');    }    //操作提现    public function doCash(){        $id = I('get.id',0,'number_int');        $M = M('money');        $info = $M->field('mid,type')->find($id);        if($info && $info['type']==9){            $info['type'] = 6;            $info['note'] = date('Y-m-d H:i:s').'打款';            if($M->save($info)){                record('提现成功,操作记录id'.$info['id']);                $this->success('操作成功');            }else{                $this->error('操作失败');            }        }else{            $this->error('记录不存在');        }    }    //通过操作    public function pass(){        $this->checkRole(array(1,3));        $id = I('get.id');        $info = M('money')->where(array('mid'=>$id))->field('mid,uid,amount,type')->find();        if($info){            if($info['type']==7){     //奖励                $amount = $info['amount'];            }else if($info['type']==8){     //扣除                $amount = -$info['amount'];            }else{                $this->error('非法操作');            }            $User = M('user');            $User->startTrans();            $r1 = $User->where('uid='.$info['uid'])->setInc('cash_money',$amount);            $r2 = M('money')->where('mid='.$info['mid'])->setField('type',$info['type']+2);            if($r1 && $r2){                $User->commit();record("通过了".$id.'号财务记录');                $this->success('操作成功');            }else{                $User->rollback();                $this->error('操作失败');            }        }else{            $this->error('记录不存在');        }    }    //删除请求    public function del(){        $id = I('get.id');        $r = M('money')->delete($id);        if($r){            $this->success('操作成功');        }else{            $this->error('操作失败');        }    }}